{% extends 'components/dashboard/sidebar/dashboard.html' %}
{% load static %}

{% block extra_css %}
<style>
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
    
    /* ESTILOS MELHORADOS PARA OS BOTÕES */
    .tab-button {
        padding: 10px 20px; 
        border: 2px solid #3b82f6;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        margin-right: 10px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
        font-size: 14px;
        font-weight: 600;
        color: #3b82f6;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .tab-button:hover {
        background: #e0f0ff;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    .tab-button.active {
        background: #3b82f6;
        color: white;
        box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
    }
    .tab-button.active:hover {
        background: #2563eb;
        border-color: #2563eb;
    }
    
    .distribuicao-tab {
        padding: 10px 20px;
        cursor: pointer;
        background-color: white;
        border: 2px solid #3b82f6;
        border-radius: 8px;
        margin-right: 10px;
        margin-bottom: 10px;
        font-weight: 600;
        color: #3b82f6;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .distribuicao-tab:hover {
        background: #e0f0ff;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    .distribuicao-tab.active {
        background-color: #3b82f6;
        color: white;
        box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
    }
    .distribuicao-tab.active:hover {
        background-color: #2563eb;
        border-color: #2563eb;
    }
    
    /* Layout responsivo para os botões */
    .distribuicao-tabs, #tabs-distribuicao {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }

    .tab-contente-grafico {
        display: none;
    }
    .tab-contente-grafico.active {
        display: block;
    }
    
    /* NOVOS ESTILOS PARA NAVEGAÇÃO COM SETAS */
    .chart-navigation {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 15px;
        gap: 15px;
    }
    
    .nav-button {
        background: linear-gradient(135deg, #7e3ff2 0%, #a066ff 100%);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-weight: bold;
        font-size: 18px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        transition: all 0.2s ease;
    }
    
    .nav-button:hover {
        background: linear-gradient(135deg, #8b5cf6 0%, #b48cff 100%);
        transform: scale(1.05);
    }
    
    .nav-button:disabled {
        background: #cccccc;
        cursor: not-allowed;
        transform: none;
    }
    
    .page-info {
        font-size: 14px;
        font-weight: 600;
        color: #666;
        min-width: 100px;
        text-align: center;
    }

    /* ESTILOS PARA INDICADOR DE FILTROS */
    .filter-indicator {
        background-color: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 20px;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .filter-tag {
        display: inline-flex;
        align-items: center;
        background-color: #3b82f6;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        margin: 0 2px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .clear-filters {
        background: none;
        border: none;
        color: #3b82f6;
        cursor: pointer;
        text-decoration: underline;
        margin-left: auto;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .clear-filters:hover {
        color: #1d4ed8;
    }

    /* Loading state */
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 2s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Cursor pointer para gráficos interativos */
    .chart-container canvas {
        cursor: pointer;
    }

    /* ESTILOS DO AG-GRID */
    #alunasGrid {
        height: 600px;
        width: 100%;
    }

    .ag-theme-alpine {
        --ag-header-height: 50px;
        --ag-header-foreground-color: white;
        --ag-header-background-color: #344767;
        --ag-header-cell-hover-background-color: #2c3e5c;
        --ag-header-cell-moving-background-color: #2c3e5c;
    }

    .ag-theme-alpine .ag-header {
        font-weight: 600;
        font-size: 0.875rem;
    }

    .ag-theme-alpine .ag-row {
        font-size: 0.875rem;
        border-bottom: 1px solid #e9ecef;
    }

    .ag-theme-alpine .ag-row:hover {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content%}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header pb-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">Alunas com Status: Rascunho ou Indeferida</h5>
                            <p class="text-sm mb-0">Total: {{ alunas|length }} alunas</p>
                        </div>
                        <div class="d-flex gap-2">
                            <span class="badge bg-warning">Rascunho: {{ count_rascunho }}</span>
                            <span class="badge bg-danger">Indeferida: {{ count_indeferida }}</span>
                        </div>
                    </div>
                </div>
                <div class="card-body px-0 pt-0 pb-2">
                    <div id="alunasGrid" style="height: 600px; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts necessários -->
<link rel="stylesheet" href="https://unpkg.com/ag-grid-community@30.0.5/styles/ag-grid.css">
<link rel="stylesheet" href="https://unpkg.com/ag-grid-community@30.0.5/styles/ag-theme-alpine.css">
<script src="https://unpkg.com/ag-grid-community@30.0.5/dist/ag-grid-community.min.js"></script>

<script>
    // Função para inicializar o Ag-Grid
    function initGrid() {
        console.log('Iniciando Ag-Grid...');
        
        const gridDiv = document.getElementById('alunasGrid');
        if (!gridDiv) {
            console.error('Elemento #alunasGrid não encontrado');
            return;
        }

        // Verifica se Ag-Grid está disponível
        if (typeof agGrid === 'undefined') {
            console.error('Ag-Grid não carregado');
            setTimeout(initGrid, 1000);
            return;
        }

        console.log('Ag-Grid carregado, criando grid...');

        const columnDefs = [
            {
                headerName: 'Nome Completo',
                field: 'nome_completo',
                filter: true,
                sortable: true,
                flex: 2
            },
            {
                headerName: 'Email',
                field: 'email',
                filter: true,
                sortable: true,
                flex: 2
            },
            {
                headerName: 'Status',
                field: 'status',
                filter: true,
                sortable: true,
                flex: 1,
                cellStyle: function(params) {
                    if (params.value === 'Rascunho') {
                        return { 
                            'backgroundColor': '#fff3cd',
                            'color': '#856404',
                            'fontWeight': 'bold',
                            'textAlign': 'center'
                        };
                    } else if (params.value === 'Indeferida') {
                        return { 
                            'backgroundColor': '#f8d7da',
                            'color': '#721c24',
                            'fontWeight': 'bold',
                            'textAlign': 'center'
                        };
                    }
                    return null;
                }
            },
            {
                headerName: 'Projeto',
                field: 'projeto',
                filter: true,
                sortable: true,
                flex: 1
            },
            {
                headerName: 'Data de Criação',
                field: 'criado_em',
                filter: true,
                sortable: true,
                flex: 1
            }
        ];

        // Dados do Django
        let rowData = [];
        try {
            rowData = {{ alunas_data|safe }};
            console.log('Dados do Django carregados:', rowData.length, 'registros');
        } catch (error) {
            console.error('Erro ao carregar dados:', error);
            
        }

        const gridOptions = {
            columnDefs: columnDefs,
            rowData: rowData,
            pagination: true,
            paginationPageSize: 20,
            defaultColDef: {
                resizable: true,
                filter: true,
                sortable: true,
            },
            onGridReady: function(params) {
                console.log('Grid pronto!');
                params.api.sizeColumnsToFit();
            },
            onFirstDataRendered: function(params) {
                console.log('Dados renderizados!');
                params.api.sizeColumnsToFit();
            }
        };

        try {
            new agGrid.Grid(gridDiv, gridOptions);
            console.log('Grid criado com sucesso!');
        } catch (error) {
            console.error('Erro ao criar grid:', error);
        }
    }

    // Inicia quando a página carregar
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM carregado, aguardando recursos...');
        setTimeout(initGrid, 500);
    });

    // Também tenta quando a janela carregar completamente
    window.addEventListener('load', initGrid);
</script>
{% endblock %}