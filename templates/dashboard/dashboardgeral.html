{% extends 'components/dashboard/sidebar/dashboard.html' %}
{% load static %}

{% block extra_css %}
{% endblock %}

{% block content%}
    <h1 class="text-2xl font-bold text-gray-800 mb-1">Gráficos e Análises</h1>
    <p class="text-sm text-gray-600 mb-4">
        Visualizações completas dos dados do programa Futuras Cientistas com análises detalhadas de performance, diversidade e evolução temporal.
    </p>

    <!-- BIG NUMBERS -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div class="bg-white shadow rounded-lg p-6 text-center">
            <h3 class="text-gray-600 text-sm font-medium">Total de Projetos</h3>
            <p id="total-projetos" class="text-3xl font-bold text-indigo-600 mt-2">0</p>
        </div>
        <div class="bg-white shadow rounded-lg p-6 text-center">
            <h3 class="text-gray-600 text-sm font-medium">Projetos Iniciados</h3>
            <p id="total-iniciados" class="text-3xl font-bold text-green-600 mt-2">0</p>
        </div>
        <div class="bg-white shadow rounded-lg p-6 text-center">
            <h3 class="text-gray-600 text-sm font-medium">Projetos Concluídos</h3>
            <p id="total-concluidos" class="text-3xl font-bold text-blue-600 mt-2">0</p>
        </div>
    </div>
    <!-- /BIG NUMBERS -->

    <div class="w-full">
        <div class="flex flex-col -mx-2" style="display: none;">
            <div class="w-full px-2">
                <h2 class="text-xl font-bold text-gray-800 mb-1">Evolução Temporal</h2>
            </div>

            <div class="w-full px-2 flex gap-5 flex-col md:flex-row">
                <div class="w-full md:w-1/2">
                    <div class="bg-white shadow-md rounded-lg h-96 relative">
                        <canvas id="graficoEvolucaoInscricoesProjeto"></canvas>
                    </div>
                </div>
                  
                <div class="w-full md:w-1/2">
                    <div class="bg-white shadow-md rounded-lg h-96 relative">
                        <canvas id="graficoFunilPerformanceAlunas"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- NOVOS GRÁFICOS: Regional e Formação -->
        <div class="flex flex-col md:flex-row gap-5 -mx-2 mt-8">
            <div class="w-full md:w-1/2 px-2">
                <h2 class="text-xl font-bold text-gray-800 mb-2">Distribuição Regional de Projetos</h2>
                <div class="bg-white shadow-md rounded-lg h-96 relative">
                    <canvas id="graficoDistribuicaoRegional"></canvas>
                </div>
            </div>

            <div class="w-full md:w-1/2 px-2">
                <h2 class="text-xl font-bold text-gray-800 mb-2">Inscrições por Estado</h2>
                <div class="bg-white shadow-md rounded-lg h-96 relative">
                    <canvas id="graficoDistribuicaoEstados"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{% static 'js/graficos_chartjs.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <script>
        // Atualiza os Big Numbers com dados da rota /api/projetos-em-andamento/
        async function atualizarBigNumbers() {
            try {
                const resp = await fetch('/usuarios/api/projetos-em-andamento/');
                if (!resp.ok) throw new Error('Erro ao buscar projetos');
                const data = await resp.json();

                // use os totais que vêm prontos da API
                document.getElementById('total-projetos').textContent   = data.total_projetos ?? 0;
                document.getElementById('total-concluidos').textContent = data.total_concluido ?? 0;

                // se quiser exibir “em andamento”, use o length do array
                document.getElementById('total-iniciados').textContent  =
                    (data.projetos_em_andamento || []).length;
            } catch (error) {
                console.error('Erro Big Numbers:', error);
            }
        }


        // --- Funções de gráficos existentes ---
        async function fetchDadosDiversidade() {
            try {
                const response = await fetch('/usuarios/api/dashboard-diversidade/');
                if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
                const data = await response.json();
                if (data.status === 'error') throw new Error(data.message);
                return data.dados_diversidade;
            } catch (error) {
                console.error('Erro ao buscar dados:', error);
                return null;
            }
        }

        async function fetchDadosDistribuicaoRegional() {
            try {
                const response = await fetch('/usuarios/api/distribuicao-regional/');
                const data = await response.json();
                return data.dados_distribuicao;
            } catch (error) {
                console.error('Erro ao buscar dados de distribuição regional:', error);
                return null;
            }
        }

        async function fetchDadosDistribuicaoEstados() {
            try {
                const response = await fetch('/usuarios/api/distribuicao-estados/');
                const data = await response.json();
                return data.dados_distribuicao;
            } catch (error) {
                console.error('Erro ao buscar dados de distribuição por estado:', error);
                return null;
            }
        }

        async function fetchDadosDistribuicaoFormacao() {
            try {
                const response = await fetch('/usuarios/api/distribuicao-formacao/');
                if (!response.ok) throw new Error('Erro na API Distribuição Formação');
                const data = await response.json();
                return data.dados_distribuicao_formacao;
            } catch (error) {
                console.error('Erro ao buscar dados de formação:', error);
                return null;
            }
        }

        async function fetchDadosEvolucaoTemporal() {
            try {
                const response = await fetch('/usuarios/api/evolucao-temporal/');
                if (!response.ok) throw new Error('Erro na API Evolução Temporal');
                const data = await response.json();
                return data.dados_evolucao;
            } catch (error) {
                console.error('Erro ao buscar dados de evolução:', error);
                return null;
            }
        }

        async function fetchDadosFunilPerformance() {
            try {
                const response = await fetch('/usuarios/api/funil-performance/');
                if (!response.ok) throw new Error('Erro na API Funil Performance');
                const data = await response.json();
                return data.dados_funil;
            } catch (error) {
                console.error('Erro ao buscar dados do funil:', error);
                return null;
            }
        }

        async function inicializarTodosGraficos() {
            // Chamada inicial dos Big Numbers
            atualizarBigNumbers();

            // Gráfico de Barras Diversidade
            const dadosDiversidade = await fetchDadosDiversidade();
            if (dadosDiversidade && dadosDiversidade.grafico_barra) {
                new Chart(document.getElementById('graficoBarra'), {
                    type: 'bar',
                    data: {
                        labels: dadosDiversidade.grafico_barra.labels,
                        datasets: dadosDiversidade.grafico_barra.datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: 'Distribuição por Tipos de Cota' },
                            legend: { position: 'bottom' }
                        },
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Quantidade' } },
                            x: { title: { display: true, text: 'Tipos de Cota' } }
                        }
                    }
                });
            }

            // Evolução Temporal
            const dadosEvolucao = await fetchDadosEvolucaoTemporal();
            if (dadosEvolucao) {
                new Chart(document.getElementById('graficoEvolucaoInscricoesProjeto'), {
                    type: 'line',
                    data: {
                        labels: dadosEvolucao.labels,
                        datasets: dadosEvolucao.datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: 'Evolução de Inscrições e Projetos' },
                            legend: { position: 'bottom' }
                        },
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Quantidade' } }
                        }
                    }
                });
            }

            // Funil Performance
            const dadosFunil = await fetchDadosFunilPerformance();
            if (dadosFunil) {
                const totalInscritas = dadosFunil.datasets[0].data[0];
                const percentages = dadosFunil.datasets[0].data.map(value => ((value / totalInscritas) * 100).toFixed(1) + '%');
                new Chart(document.getElementById('graficoFunilPerformanceAlunas'), {
                    type: 'line',
                    data: {
                        labels: dadosFunil.labels,
                        datasets: [{ ...dadosFunil.datasets[0], borderWidth: 3 }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: 'Funil de Performance das Alunas' },
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const index = context.dataIndex;
                                        const value = context.dataset.data[index];
                                        const percentage = percentages[index];
                                        return `${dadosFunil.labels[index]}: ${value} (${percentage})`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Quantidade de Alunas' } },
                            x: { title: { display: true, text: 'Etapas do Processo' } }
                        }
                    }
                });
            }

            // Distribuição Regional
            const dadosDistribuicao = await fetchDadosDistribuicaoRegional();
            if (dadosDistribuicao) {
                new Chart(document.getElementById('graficoDistribuicaoRegional'), {
                    type: 'bar',
                    data: {
                        labels: dadosDistribuicao.labels,
                        datasets: [{
                            label: 'Projetos Cadastrados',
                            data: dadosDistribuicao.data,
                            backgroundColor: dadosDistribuicao.backgroundColor,
                            borderRadius: 8,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Quantidade de Projetos' } },
                            x: { title: { display: true, text: 'Regiões do Brasil' } }
                        }
                    }
                });
            }

            // Distribuição por Estado
            const dadosDistribuicaoEstados = await fetchDadosDistribuicaoEstados();
            if (dadosDistribuicaoEstados) {
                new Chart(document.getElementById('graficoDistribuicaoEstados'), {
                    type: 'bar',
                    data: {
                        labels: dadosDistribuicaoEstados.labels,
                        datasets: [{
                            label: 'Aplicações',
                            data: dadosDistribuicaoEstados.data,
                            backgroundColor: dadosDistribuicaoEstados.backgroundColor,
                            borderRadius: 6,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                anchor: 'center',
                                align: 'center',
                                color: '#000',
                                font: { weight: 'bold', size: 11 },
                                formatter: (value) => value
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true, 
                                grid: { display: false },
                                ticks: { display: false }
                            },
                            x: { 
                                title: { display: true, text: 'Estados' },
                                grid: { display: false } 
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // Distribuição Formação
            const dadosFormacao = await fetchDadosDistribuicaoFormacao();
            if (dadosFormacao) {
                new Chart(document.getElementById('graficoDistribuicaoFormacao'), {
                    type: 'pie',
                    data: {
                        labels: dadosFormacao.labels,
                        datasets: [{
                            data: dadosFormacao.data,
                            backgroundColor: dadosFormacao.backgroundColor,
                            borderWidth: 1,
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'right',
                                labels: { padding: 15, usePointStyle: true }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', inicializarTodosGraficos);
    </script>
{% endblock %}
